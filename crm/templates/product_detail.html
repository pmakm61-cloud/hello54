<!-- hello54_crm/templates/product_detail.html -->
{% extends "layout.html" %}

{% block title %}{{ product.prod_name|default("–¢–æ–≤–∞—Ä") }} - Hello54 CRM{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    
    <div class="product-detail">
        <div class="product-header">
            <h1>{{ product.prod_name|default("–¢–æ–≤–∞—Ä –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è") }}</h1>
            <span class="product-id">ID: {{ product.id }}</span>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="product-info-grid">
            <div class="info-card">
                <h3>üí∞ –¶–µ–Ω—ã</h3>
                <div class="price-block">
                    {% if product.prod_price_new %}
                        <div class="current-price">{{ product.prod_price_new }} ‚ÇΩ</div>
                        {% if product.prod_price_old %}
                            <div class="old-price">{{ product.prod_price_old }} ‚ÇΩ</div>
                        {% endif %}
                    {% else %}
                        <div class="no-price">–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="info-card">
                <h3>üìã –î–µ—Ç–∞–ª–∏</h3>
                <ul>
                    <li><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> {{ product.prod_article|default("‚Äî") }}</li>
                    <li><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                        <span class="status-badge status-{{ product.parse_status|default('pending', true) }}">
                            {{ product.parse_status|default("pending", true) }}
                        </span>
                    </li>
                    <li><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ product.created_at|default("‚Äî") }}</li>
                    <li><strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong> {{ product.updated_at|default("‚Äî") }}</li>
                </ul>
            </div>
            
            <div class="info-card">
                <h3>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
                {% if product.img_local_path %}
                    <div class="image-preview">
                        <img src="file://{{ product.img_local_path }}" 
                             alt="{{ product.prod_name }}"
                             onerror="this.style.display='none'">
                        <p>{{ product.img_local_path }}</p>
                    </div>
                {% elif product.prod_img_url %}
                    <p>URL: <a href="{{ product.prod_img_url }}" target="_blank">{{ product.prod_img_url|truncate(40) }}</a></p>
                    <button onclick="downloadImage({{ product.id }})" class="btn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
                {% else %}
                    <p>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                {% endif %}
            </div>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="action-panel">
            <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="action-buttons">
                <button onclick="parseProduct({{ product.id }})" class="btn btn-primary">
                    üîÑ –ü–∞—Ä—Å–∏—Ç—å –∑–∞–Ω–æ–≤–æ (Selenium)
                </button>
                <button onclick="parseProductFast({{ product.id }})" class="btn">
                    ‚ö° –ü–∞—Ä—Å–∏—Ç—å –±—ã—Å—Ç—Ä–æ (–±–µ–∑ Selenium)
                </button>
                {% if not product.img_local_path and product.prod_img_url %}
                    <button onclick="downloadImage({{ product.id }})" class="btn btn-success">
                        üñºÔ∏è –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
                    </button>
                {% endif %}
            </div>
        </div>
        
        <!-- URL –∏ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="url-info">
            <h3>üîó –°—Å—ã–ª–∫–∏</h3>
            <p><strong>URL —Ç–æ–≤–∞—Ä–∞:</strong> <a href="{{ product.url }}" target="_blank">{{ product.url|truncate(80) }}</a></p>
            {% if product.prod_img_url %}
                <p><strong>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏:</strong> <a href="{{ product.prod_img_url }}" target="_blank">{{ product.prod_img_url|truncate(80) }}</a></p>
            {% endif %}
        </div>
        
        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
        {% if product.prod_characteristics %}
        <div class="characteristics">
            <h3>üìù –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
            <table class="char-table">
                {% for key, value in product.prod_characteristics.items() %}
                <tr>
                    <th>{{ key }}</th>
                    <td>{{ value }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}
    </div>
</div>

<script>
async function parseProduct(productId) {
    const response = await fetch(`/api/parser/parse/${productId}?use_selenium=true`, {
        method: 'POST'
    });
    const result = await response.json();
    alert(result.success ? '‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω' : '‚ùå –û—à–∏–±–∫–∞: ' + result.error);
}

async function parseProductFast(productId) {
    const response = await fetch(`/api/parser/parse/${productId}?use_selenium=false`, {
        method: 'POST'
    });
    const result = await response.json();
    alert(result.success ? '‚úÖ –ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω' : '‚ùå –û—à–∏–±–∫–∞');
}

async function downloadImage(productId) {
    const response = await fetch(`/api/images/download/${productId}`, {
        method: 'POST'
    });
    const result = await response.json();
    alert(result.success ? '‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–ø—É—â–µ–Ω–∞' : '‚ùå –û—à–∏–±–∫–∞');
}
</script>
{% endblock %}