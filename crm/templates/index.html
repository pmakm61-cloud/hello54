<!-- hello54_crm/templates/index.html -->
{% extends "layout.html" %}

{% block title %}–¢–æ–≤–∞—Ä—ã - Hello54 CRM{% endblock %}

{% block content %}
<div class="container">
    <h1>üì¶ –¢–æ–≤–∞—Ä—ã –≤ –±–∞–∑–µ</h1>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="quick-actions">
        <button onclick="parseBatch(10)">üîÑ –°–ø–∞—Ä—Å–∏—Ç—å 10 —Ç–æ–≤–∞—Ä–æ–≤</button>
        <button onclick="downloadBatchImages(10)">üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å 10 –∫–∞—Ä—Ç–∏–Ω–æ–∫</button>
        <button onclick="location.href='/stats'">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–≤–µ—Ä—Ö—É -->
    {% if stats %}
    <div class="stats-summary">
        –í—Å–µ–≥–æ: {{ stats.total_products }} | 
        –£—Å–ø–µ—à–Ω–æ: {{ stats.parsed_success }} | 
        –û—à–∏–±–æ–∫: {{ stats.parsed_failed }} | 
        –û–∂–∏–¥–∞—é—Ç: {{ stats.pending }} |
        –° –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏: {{ stats.has_local_image }}
    </div>
    {% endif %}
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <table class="products-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ö–∞—Ä—Ç–∏–Ω–∫–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.id }}</td>
                <td>
                    <a href="/product/{{ product.id }}" title="{{ product.prod_name }}">
                        {{ product.prod_name|default("–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è", true)|truncate(40) }}
                    </a>
                </td>
                <td class="price">
                    {% if product.prod_price_new %}
                        {{ product.prod_price_new }} ‚ÇΩ
                        {% if product.prod_price_old %}
                            <del>{{ product.prod_price_old }} ‚ÇΩ</del>
                        {% endif %}
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
                <td>{{ product.prod_article|default("‚Äî", true) }}</td>
                <td class="status status-{{ product.parse_status|default('pending', true) }}">
                    {{ product.parse_status|default("pending", true) }}
                </td>
                <td class="image-status">
                    {% if product.img_local_path %}
                        ‚úÖ
                    {% elif product.prod_img_url %}
                        üîó
                    {% else %}
                        ‚ùå
                    {% endif %}
                </td>
                <td class="actions">
                    <button onclick="parseProduct({{ product.id }})" 
                            class="btn-small" title="–ü–∞—Ä—Å–∏—Ç—å">üîÑ</button>
                    <button onclick="downloadImage({{ product.id }})" 
                            class="btn-small" title="–ö–∞—Ä—Ç–∏–Ω–∫–∞">üñºÔ∏è</button>
                    <button onclick="location.href='/product/{{ product.id }}'" 
                            class="btn-small" title="–ü–æ–¥—Ä–æ–±–Ω–æ">üëÅÔ∏è</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total > limit %}
    <div class="pagination">
        {% if offset > 0 %}
            <a href="/?limit={{ limit }}&offset={{ offset - limit }}">‚Üê –ù–∞–∑–∞–¥</a>
        {% endif %}
        
        <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ (offset / limit)|int + 1 }} –∏–∑ {{ (total / limit)|round(0, 'ceil')|int }}</span>
        
        {% if offset + limit < total %}
            <a href="/?limit={{ limit }}&offset={{ offset + limit }}">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API
async function parseProduct(productId) {
    const response = await fetch(`/api/parser/parse/${productId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });
    const result = await response.json();
    showNotification(result.success ? '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω' : '–û—à–∏–±–∫–∞', result.success);
}

async function parseBatch(count) {
    const response = await fetch(`/api/parser/parse-batch?count=${count}`, {
        method: 'POST'
    });
    const result = await response.json();
    showNotification(`–ü–∞—Ä—Å–∏–Ω–≥ ${count} —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω`, result.success);
}

async function downloadImage(productId) {
    const response = await fetch(`/api/images/download/${productId}`, {
        method: 'POST'
    });
    const result = await response.json();
    showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–ø—É—â–µ–Ω–∞', result.success);
}

async function downloadBatchImages(count) {
    const response = await fetch(`/api/images/download-batch?count=${count}`, {
        method: 'POST'
    });
    const result = await response.json();
    showNotification(`–ó–∞–≥—Ä—É–∑–∫–∞ ${count} –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∑–∞–ø—É—â–µ–Ω–∞`, result.success);
}

function showNotification(message, isSuccess = true) {
    const notification = document.createElement('div');
    notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}
</script>
{% endblock %}